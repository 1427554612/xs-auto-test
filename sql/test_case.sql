/*
 Navicat Premium Data Transfer

 Source Server         : 192.168.0.175_3306
 Source Server Type    : MySQL
 Source Server Version : 50744
 Source Host           : 192.168.0.175:3306
 Source Schema         : auto-test

 Target Server Type    : MySQL
 Target Server Version : 50744
 File Encoding         : 65001

 Date: 26/11/2025 17:52:46
*/

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for test_case
-- ----------------------------
DROP TABLE IF EXISTS `test_case`;
CREATE TABLE `test_case`  (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `class_name` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '类名',
  `des` varchar(200) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '说明',
  `create_time` datetime(0) NULL DEFAULT NULL COMMENT '创建时间',
  `update_time` datetime(0) NULL DEFAULT NULL COMMENT '最后修改时间',
  `version` int(11) NULL DEFAULT NULL COMMENT '修改版本',
  `is_main` int(11) NULL DEFAULT NULL COMMENT '是否是主流程：0 不是，1 是',
  `update_by` varchar(10) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '修改人',
  `code` text CHARACTER SET utf8 COLLATE utf8_general_ci NULL COMMENT '核心代码',
  `case_type` int(1) NULL DEFAULT NULL COMMENT '用例类型，0：异常，1：正常',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 3 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;

-- ----------------------------
-- Records of test_case
-- ----------------------------
INSERT INTO `test_case` VALUES (1, 'BaseTestCase', '基础测试类', '2025-11-12 20:31:05', '2025-11-26 11:54:42', 1, 1, '张军', 'import com.microsoft.playwright.Page;\nimport com.xs.auto.test.ui_auto_test.entity.TestCase;\nimport com.xs.auto.test.ui_auto_test.entity.TestCaseConfig;\nimport com.xs.auto.test.ui_auto_test.log.WebsocketLogFactory;\nimport com.xs.auto.test.ui_auto_test.mapper.TestCaseRunInfoMapper;\nimport com.xs.auto.test.ui_auto_test.utils.ScreensUtil;\nimport com.xs.auto.test.web.api.FtpServerApi;\nimport com.xs.auto.test.web.websocket.WebSocketController;\nimport org.springframework.stereotype.Component;\nimport java.io.File;\nimport java.nio.file.Files;\nimport java.util.Map;\n\n/**\n * 基础测试类\n */\n\n@Component\npublic class BaseTestCase<T>{\n   public Page page;\n   public ScreensUtil screensUtil;\n   public TestCaseRunInfoMapper testCaseRunInfoMapper;\n   public FtpServerApi ftpServerApi;\n   public TestCase testCase;\n   public TestCaseConfig testCaseConfig;\n   public WebSocketController webSocketController;\n   public WebsocketLogFactory websocketLogFactory;\n   public String userName;\n   private boolean initialized = false;\n  \n   public void setUserName(String userName) {\n      this.userName = userName;\n   }\n\n   public Page getPage() {\n      return page;\n   }\n\n   public void setPage(Page page) {\n      this.page = page;\n      this.screensUtil = new ScreensUtil(page);\n   }\n\n   public void setTestCase(TestCase testCase){\n      this.testCase = testCase;\n   }\n\n   public void setTestCaseConfig(TestCaseConfig testCaseConfig) {\n      this.testCaseConfig = testCaseConfig;\n   }\n\n   public void setTestCaseRunInfoMapper(TestCaseRunInfoMapper testCaseRunInfoMapper) {\n      this.testCaseRunInfoMapper = testCaseRunInfoMapper;\n   }\n\n   public void setFtpServerApi(FtpServerApi ftpServerApi) {\n      this.ftpServerApi = ftpServerApi;\n   }\n\n    public void init(Class<T> tClass){\n        if (!initialized) {\n            System.out.println(\"=== 延迟初始化 ===\");\n            System.out.println(\"初始化时的 userName: \" + this.userName);\n            websocketLogFactory = new WebsocketLogFactory(tClass, webSocketController, this.userName);\n            websocketLogFactory.info(\"正在初始化baseTestCase......\");\n            websocketLogFactory.info(\"websocket链接用户：\" + this.userName);\n            websocketLogFactory.info(\"装载的测试用例类为：\" + tClass.getName());\n            websocketLogFactory.info(\"websocketLogFactory已创建......\");\n            initialized = true;\n        }\n      // 清空日志\n      websocketLogFactory.clearLogs();\n      System.out.println(\"当前日志的内容为：\" + websocketLogFactory.stringBuilder.toString());\n    }\n    \n    // 添加一个检查方法，确保在使用前已初始化\n    protected void ensureInitialized(Class<T> tClass) {\n        if (!initialized) {\n            init(tClass);\n        }\n    }\n\n\n   /**\n    * 后置操作\n    */\n   public void after(){\n      websocketLogFactory.info(\"baseTestCase after已执行......\");\n   }\n\n   /**\n    * 上传结果到minio，同时返回结果map\n    */\n  public Map<String,Object> resultUpload(String methodName) {\n      Map<String,Object> resultMap = null;\n      try {\n         websocketLogFactory.info(\"开始执行截图上传流程...\");\n\n         // 检查必要的依赖\n         if (screensUtil == null) {\n            websocketLogFactory.error(\"screensUtil 为 null，无法截图\");\n            return null;\n         }\n         if (ftpServerApi == null) {\n            websocketLogFactory.error(\"ftpServerApi 为 null，无法上传文件\");\n            return null;\n         }\n\n         websocketLogFactory.info(\"开始截图...\");\n         String localFilePath = this.screensUtil.screen(methodName, System.currentTimeMillis()+\".png\");\n         websocketLogFactory.info(\"本地图片路径：\" + localFilePath);\n\n         // 检查文件是否存在\n         File file = new File(localFilePath);\n         if (!file.exists()) {\n            websocketLogFactory.error(\"截图文件不存在：\" + localFilePath);\n            return null;\n         }\n\n         websocketLogFactory.info(\"截图文件存在，大小：\" + file.length() + \" bytes\");\n\n         // 读取文件为字节数组\n         byte[] fileBytes = Files.readAllBytes(file.toPath());\n         websocketLogFactory.info(\"文件读取完成，字节数组长度：\" + fileBytes.length);\n\n         // 检查文件大小\n         if (fileBytes.length == 0) {\n            websocketLogFactory.error(\"截图文件为空：\" + localFilePath);\n            return null;\n         }\n\n         // 获取文件类型\n         String contentType = Files.probeContentType(file.toPath());\n         websocketLogFactory.info(\"文件类型：\" + contentType);\n\n         // 调用字节数组版本的上传方法\n         websocketLogFactory.info(\"开始调用FTP上传接口...\");\n         resultMap = ftpServerApi.uploadFileBytes(\n                 fileBytes,\n                 file.getName(),\n                 contentType,\n                 methodName\n         );\n\n         if (resultMap != null) {\n            websocketLogFactory.info(\"上传成功的图片数据:\" + resultMap);\n         } else {\n            websocketLogFactory.error(\"图片上传返回结果为null\");\n         }\n\n      } catch (Exception e) {\n         websocketLogFactory.error(\"截图上传失败: \" + e.getMessage());\n         e.printStackTrace();\n      }\n\n      return resultMap;\n   }\n}', 1);
INSERT INTO `test_case` VALUES (2, 'UserTestCase', '用户相关用例', '2025-11-06 11:15:10', '2025-11-26 11:46:38', 1, 1, '张军', 'import com.xs.auto.test.ui_auto_test.entity.TestCaseRunInfo;\nimport java.time.Duration;\nimport java.time.LocalDateTime;\nimport org.springframework.stereotype.Component;\nimport static com.microsoft.playwright.assertions.PlaywrightAssertions.assertThat;\n\n\n@Component\npublic class UserTestCase extends BaseTestCase {\n\n    public HomePage homePage;\n    public UserPage userPage;\n\n    public UserTestCase(){\n        super();\n    }\n\n    public void setHomePage(HomePage homePage) {\n        this.homePage = homePage;\n    }\n\n    public void setUserPage(UserPage userPage) {\n        this.userPage = userPage;\n    }\n\n    /**\n     * 测试正常登录\n     */\n    public void testLogin(){\n        super.init(UserTestCase.class);\n        websocketLogFactory.info(\"testLogin用例开始执行......\");\n        LocalDateTime now = LocalDateTime.now();\n        TestCaseRunInfo testCaseRunInfo = new TestCaseRunInfo().setConfigId(testCaseConfig.getId()).setStartTime(LocalDateTime.now())\n                .setClassName(new Object(){}.getClass().getEnclosingClass().getSimpleName())\n                .setMethodName(new Object(){}.getClass().getEnclosingMethod().getName())\n                .setCaseId(super.testCase.getId()).setUpdateBy(\"zhangjun\");\n        try {\n            websocketLogFactory.info(\"selectGamePage 执行通过......\");\n            homePage.gotoHome();\n            websocketLogFactory.info(\"gotoHome 执行通过......\");\n            userPage.login(\"zhangjun@qq.com\",\"123456\");\n            websocketLogFactory.info(\"login 执行通过......\");\n            testCaseRunInfo.setEndTime(LocalDateTime.now()).setRunTime(Duration.between(now,LocalDateTime.now()).getSeconds()).setRunResult(1);\n        }\n        catch (Exception | AssertionError error){\n            websocketLogFactory.error(\"testHome执行失败....，错误信息:\" + error.getMessage());\n            testCaseRunInfo.setEndTime(LocalDateTime.now())\n                    .setRunTime(Duration.between(now,LocalDateTime.now()).getSeconds())\n                    .setRunResult(0).setErrorMsg(error.getMessage());\n        }finally{\n            testCaseRunInfo.setImgInfo(super.resultUpload(testCaseRunInfo.getMethodName()));\n            websocketLogFactory.info(\"testLogin 结果插入成功！！！\");\n            testCaseRunInfo.setRunLog(websocketLogFactory.info(\"testLogin 用例执行完毕......\"));\n            super.testCaseRunInfoMapper.insert(testCaseRunInfo);\n        }\n    }\n\n    /**\n     * 测试异常登录\n     */\n    public void testLoginError(){\n        super.init(UserTestCase.class);\n        websocketLogFactory.info(\"testLoginError用例开始执行......\");\n        LocalDateTime now = LocalDateTime.now();\n        TestCaseRunInfo testCaseRunInfo = new TestCaseRunInfo().setConfigId(testCaseConfig.getId()).setStartTime(LocalDateTime.now())\n                .setClassName(new Object(){}.getClass().getEnclosingClass().getSimpleName())\n                .setMethodName(new Object(){}.getClass().getEnclosingMethod().getName())\n                .setCaseId(super.testCase.getId()).setUpdateBy(\"zhangjun\");\n        try {\n            websocketLogFactory.info(\"selectGamePage 执行通过......\");\n            userPage.login(\"zhangjun@qq.com\",\"654321\");\n            assertThat(page.locator(\"#JogosLogin > div.jogos-login-dialog.absolute > div > div.page-main.mt-30px > div:nth-child(2) > p\")).hasText(\"Login Failed: Incorrect Account or Password\");\n            websocketLogFactory.info(\"testLoginError 执行通过......\");\n            testCaseRunInfo.setEndTime(LocalDateTime.now()).setRunTime(Duration.between(now,LocalDateTime.now()).getSeconds()).setRunResult(1);\n        }\n        catch (Exception | AssertionError error){\n            websocketLogFactory.error(\"testLoginError 执行失败....，错误信息:\" + error.getMessage());\n            testCaseRunInfo.setEndTime(LocalDateTime.now())\n                    .setRunTime(Duration.between(now,LocalDateTime.now()).getSeconds())\n                    .setRunResult(0).setErrorMsg(error.getMessage());\n        }\n        finally{\n            testCaseRunInfo.setImgInfo(super.resultUpload(testCaseRunInfo.getMethodName()));\n            websocketLogFactory.info(\"testLoginError 结果插入成功！！！\");\n            testCaseRunInfo.setRunLog(websocketLogFactory.info(\"testLoginError 用例执行完毕......\"));\n            super.testCaseRunInfoMapper.insert(testCaseRunInfo);\n        }\n    }\n    /**\n     * 测试方法\n     */\n    public void testShow(){\n        super.init(UserTestCase.class);\n        websocketLogFactory.info(\"testShow用例开始执行......\");\n        LocalDateTime now = LocalDateTime.now();\n        TestCaseRunInfo testCaseRunInfo = new TestCaseRunInfo().setConfigId(testCaseConfig.getId()).setStartTime(LocalDateTime.now())\n                .setClassName(new Object(){}.getClass().getEnclosingClass().getSimpleName())\n                .setMethodName(new Object(){}.getClass().getEnclosingMethod().getName())\n                .setCaseId(super.testCase.getId()).setUpdateBy(\"zhangjun\");\n        try {\n            homePage.selectGamePage();\n            websocketLogFactory.info(\"selectGamePage 执行通过......\");\n            int a = 10;\n            int b = 0;\n            int c = a/b;\n            testCaseRunInfo.setEndTime(LocalDateTime.now()).setRunTime(Duration.between(now,LocalDateTime.now()).getSeconds()).setRunResult(1);\n        }catch (Exception | AssertionError error){\n            websocketLogFactory.error(\"testShow执行失败....，错误信息:\" + error.getMessage());\n            testCaseRunInfo.setEndTime(LocalDateTime.now())\n                    .setRunTime(Duration.between(now,LocalDateTime.now()).getSeconds())\n                    .setRunResult(0).setErrorMsg(error.getMessage());\n        }\n        finally{\n            testCaseRunInfo.setImgInfo(super.resultUpload(testCaseRunInfo.getMethodName()));\n            websocketLogFactory.info(\"testShow 结果插入成功！！！\");\n            testCaseRunInfo.setRunLog(websocketLogFactory.info(\"testShow 用例执行完毕......\"));\n            super.testCaseRunInfoMapper.insert(testCaseRunInfo);\n        }\n    }\n}', 1);

SET FOREIGN_KEY_CHECKS = 1;
